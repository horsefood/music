class Accidental{constructor(){}static parseAccidental(e){switch(e){case"sharp":return"#";case"natural":return"n";case"flat":return"b";case"double-sharp":case"sharp-sharp":return"##";case"flat-flat":return"bb";case"quarter-sharp":return"+";case"three-quarters-flat":return"db";case"three-quarters-sharp":return"++";case"slash-sharp":return"++-";case"slash-flat":return"bs";case"double-slash-flat":return"bss";default:return""}}static parseAlter(e){switch(e){case"1":return"#";case"2":return"##";case"-1":return"b";case"-2":return"bb";default:return""}}}class Duration{constructor(){}static parseDuration(e){if(void 0===e)return"w";switch(e){case"maxima":return"1/8";case"long":return"1/4";case"breve":return"1/2";case"whole":return"w";case"half":return"h";case"quarter":return"q";case"eighth":return"8";case"16th":return"16";case"32nd":return"32";case"64th":return"64";case"128th":return"128";case"256th":return"b";case"512th":return"512";case"1024th":return"1024"}}}class Clef{constructor(){}static parseClef(e){if("undefind"==typeof e)return"treble";const t=e.sign,n=e.line;return"G"==t?"1"==n?"french":"treble":"F"==t?"3"==n?"baritone-f":"5"==n?"subbass":"bass":"C"==t?"1"==n?"soprano":"2"==n?"mezzo-soprano":"3"==n?"alto":"4"==n?"tenor":"baritone-c":"percussion"}}class Key{constructor(){}static parseKey(e){if("undefind"==typeof e)return"C";const t=e.fifths,n=e.mode;if("major"==n){if("0"==t)return"C";if("1"==t)return"G";if("2"==t)return"D";if("3"==t)return"A";if("4"==t)return"E";if("5"==t)return"B";if("6"==t)return"F#";if("7"==t)return"C#";if("-1"==t)return"F";if("-2"==t)return"Bb";if("-3"==t)return"Eb";if("-4"==t)return"Ab";if("-5"==t)return"Db";if("-6"==t)return"Gb";if("-7"==t)return"Cb"}else if("minor"==n){if("0"==t)return"Am";if("1"==t)return"Em";if("2"==t)return"Bm";if("3"==t)return"F#m";if("4"==t)return"C#m";if("5"==t)return"G#m";if("6"==t)return"D#m";if("7"==t)return"A#m";if("-1"==t)return"Dm";if("-2"==t)return"Gm";if("-3"==t)return"Cm";if("-4"==t)return"Fm";if("-5"==t)return"Bbm";if("-6"==t)return"Ebm";if("-7"==t)return"Abm"}}static ksCount(e){if("undefind"==typeof e)return 0;switch(e){case"C":case"a":return 0;case"G":case"F":case"e":case"d":return 1;case"D":case"Bb":case"b":case"g":return 2;case"A":case"Eb":case"f#":case"c":return 3;case"E":case"Ab":case"c#":case"f":return 4;case"B":case"Db":case"g#":case"bb":return 5;case"F#":case"Gb":case"d#":case"eb":return 6;case"C#":case"Cb":return 7;default:return 0}}static keyPosition(e){let t=new HashMap;if(t.set("A",0).set("B",0).set("C",0).set("D",0).set("E",0).set("F",0).set("G",0),"undefind"==typeof e)return t;switch(e){case"C":break;case"G":t.set("F",1);break;case"D":t.set("F",1).set("C",1);break;case"A":t.set("F",1).set("C",1).set("G",1);break;case"E":t.set("F",1).set("C",1).set("G",1).set("D",1);break;case"B":t.set("F",1).set("C",1).set("G",1).set("D",1).set("A",1);break;case"F#":t.set("F",1).set("C",1).set("G",1).set("D",1).set("A",1).set("E",1);break;case"C#":t.set("F",1).set("C",1).set("G",1).set("D",1).set("A",1).set("E",1).set("B",1);break;case"Cb":t.set("B",1).set("E",1).set("A",1).set("D",1).set("G",1).set("C",1).set("F",1);break;case"Gb":t.set("B",1).set("E",1).set("A",1).set("D",1).set("G",1).set("C",1);break;case"Db":t.set("B",1).set("E",1).set("A",1).set("D",1).set("G",1);break;case"Ab":t.set("B",1).set("E",1).set("A",1).set("D",1);break;case"Eb":t.set("B",1).set("E",1).set("A",1);break;case"Bb":t.set("B",1).set("E",1);break;case"F":t.set("B",1)}return t}}class Time{constructor(){}static parseTime(e){if("undefind"==typeof e)return"4/4";return e.beats+"/"+e.type}static parseType(e){if(void 0===e)return"whole";switch(e){case"1":return"whole";case"2":return"half";case"4":return"quarter";case"8":return"eighth";case"16":return"16th";case"32":return"32nd";case"64":return"64th";case"128":return"128th";case"256":return"256th";case"512":return"512th";case"1024":return"1024th"}}static parseNumType(e){if(void 0===e)return"1";switch(e){case"whole":return"1";case"half":return"2";case"quarter":return"4";case"eighth":return"8";case"16th":return"16";case"32nd":return"32";case"64th":return"64";case"128th":return"128";case"256th":return"256";case"512th":return"512";case"1024th":return"1024"}}}class Score{constructor(){}display(e,t,n,s){const r=new Array(n.part.length),o=new Array(n.part.length),a=new Array(n.part.length),i=Number(n.part.length)-1,[l,c,u]=this.setPartAttr(n.partlist,n.part.length);o.partnames=l,o.partbarlines=c,o.partsymbols=u;for(let e in n.part){const t=n.part[e].measure,s=t.length,i=Number(n.view.width)-50;o[e]=new Array(s),a[e]=new Array(s),r[e]=1;let l=0;for(let n in t){const a=t[n];o[e][n]={},o[e][n].newpage=!1,o[e][n].newsystem=!1,void 0!==a.attr&&void 0!==a.attr[0].staves&&(r[e]=Number(a.attr[0].staves)),void 0!==a.newsystem&&(o[e][n].newsystem=a.newsystem),void 0!==a.newpage&&(o[e][n].newpage=a.newpage),o[e][n].newpage&&(o[e][n].newsystem=!0),o[e][n].newsystem&&0;const c=new Array(r[e]);for(let t=0;t<r[e];t++)c[t]=0;for(let e in a.note)void 0===a.note[e].chord&&(void 0!==a.note[e].staff?c[Number(a.note[e].staff)-1]++:c[0]++);let u=c[0];for(let e=1;e<c.length;e++)u<c[e]&&(u=c[e]);if(o[e][n].notelen=u,4>o[e][n].notelen&&(o[e][n].notelen+=1),(-1<a.order.indexOf("cf")||o[e][n].newsystem)&&(o[e][n].notelen+=2),void 0!==a.attr&&void 0!==a.attr[0].key){const e=Key.parseKey(a.attr[0].key);l=Key.ksCount(e)}const f=Number(n)+1;if(o[e][n].newsystem||s==f){let t=0,r=0,a=0;o[e][n].newsystem&&s==f?(a=n-1,o[e][n].size=i):a=s==f?n:n-1;for(let n=a;0<=n&&void 0===o[e][n].size;n--)t+=o[e][n].notelen,r=n;const c=(i-(12+12*l))/t;t=0;for(let n=r;n<=a;n++)o[e][n].size=Math.floor(o[e][n].notelen*c),t+=o[e][n].size;o[e][r].size+=i-t}}}if(o.mswidth=a,s.combineparts){const e=n.part[0].measure,t=e.length;let r=0,i=0;for(let c in e){const e=Number(c)+1;let u=Number(n.view.width)-50;if(o[0][c].newsystem||t==e){var f,d,p=0;i=t==e?c:c-1,0==r&&void 0!==l[0].name?u-=s.namesize:void 0!==l[0].abbreviation&&(u-=s.abbrsize),f=Number(i)-Number(r)+1;var h=new Array(f);for(let e=i;e>=r;e--){void 0===h[e]&&(h[e]=0);for(let t in n.part)h[e]<o[t][e].notelen&&(h[e]=o[t][e].notelen);p+=h[e]}d=Math.round(u/p*100)/100,p=0;for(let e=i;e>=r;e--){var y=Math.floor(h[e]*d);p+=y;for(let t in n.part)o[t][e].size=y,e==r&&(o[t][e].size+=u-p),a[t][e]=o[t][e].size}r=c}}}const v=n.part[0].measure,m=v.length;let b=0,w=new Array;var g=new Array,_=new Array,A=new Array,k=s.lineheight;for(let e in n.part)w[e]={continue:!1,number:0},_[e]=49;for(let a in v)for(let f in n.part){const d=n.part[f].measure[a],p=0==f?i:Number(f)-1;0==a&&(s.combineparts?(A[f]=s.staveheight*r[f],g[f]=0==f?s.topmargin:g[p]+A[p],void 0!==l[f].name&&(_[f]+=s.namesize)):g[f]=s.topmargin),o[f][a].times=new Array(r[f]),o[f][a].tmcnt=new Array(r[f]),o[f][a].keys=new Array(r[f]),o[f][a].kscnt=new Array(r[f]),o[f][a].staves=new Array(r[f]),o[f][a].top=new Array(r[f]),void 0===o[f][a].clef&&(o[f][a].clef=new Array),o[f][a].clef_pos=new Array,o[f][a].clef_note=new Array,o[f][a].clef_staff=new Array;let h=d.order.split(","),y=-1,v=0;if(void 0!==d.attr)for(let e in d.attr)if(void 0!==d.attr[e].clef){const t=h.length;for(let e in h)if("ne"==h[e]&&v++,"cf"==h[e]){e=Number(e),y=t==e+2||"bp"==h[e+1]?1e4:v,h.splice(0,Number(e)+1),o[f][a].clef_pos.push(y);break}for(let t in d.attr[e].clef){let n=0;if(void 0!==d.attr[e].clef[t].number&&(n=Number(d.attr[e].clef[t].number)-1),0==o[f][a].clef_pos[0])o[f][a].clef[n]=Clef.parseClef(d.attr[e].clef[t]);else{a=Number(a),m>a+1&&void 0===o[f][a+1].clef&&(o[f][a+1].clef=new Array);const s=Clef.parseClef(d.attr[e].clef[t]);o[f][a].clef_note.push(s),o[f][a].clef_staff.push(n),m>a+1&&(o[f][a+1].clef[n]=s)}}}for(let n=0;n<r[f];n++){if(o[f][a].staves[n]=new e.Stave(_[f],g[f],o[f][a].size),o[f][a].top[n]=o[f][a].staves[n].y*s.ratio.h+t[0].element.offsetTop,g[f]+=s.staveheight,-1==d.number.indexOf("X")&&(b=d.number),void 0===o[f][a].clef[n]&&(o[f][a].clef[n]=o[f][a-1].clef[n]),1==d.number&&(s.combineparts?o[0][a].staves[0].setMeasure(b):o[f][a].staves[0].setMeasure(b)),(0==a||o[f][a].newsystem)&&(s.combineparts?o[0][a].staves[0].setMeasure(b):o[f][a].staves[0].setMeasure(b),o[f][a].staves[n].addClef(o[f][a].clef[n])),0<o[f][a].clef_pos.length)for(let e in o[f][a].clef_pos){const t=o[f][a].clef_staff[e];if(t==n&&1e4==o[f][a].clef_pos[e]){o[f][a].staves[t].addEndClef(o[f][a].clef_note[e],"small");break}}if(void 0!==d.attr&&void 0!==d.attr[0].time?(o[f][a].times[n]=Time.parseTime(d.attr[0].time),o[f][a].tmcnt=1,o[f][a].staves[n].addTimeSignature(o[f][a].times[n])):(o[f][a].times[n]=o[f][a-1].times[n],o[f][a].tmcnt=0),void 0!==d.attr&&void 0!==d.attr[0].key?(o[f][a].keys[n]=Key.parseKey(d.attr[0].key),o[f][a].kscnt[n]=Key.ksCount(o[f][a].keys[n]),o[f][a].staves[n].addKeySignature(o[f][a].keys[n])):(o[f][a].keys[n]=o[f][a-1].keys[n],0==a||o[f][a].newsystem?(o[f][a].kscnt[n]=Key.ksCount(o[f][a].keys[n]),o[f][a].staves[n].addKeySignature(o[f][a].keys[n])):o[f][a].kscnt[n]=0),void 0!==d.barline)for(let t in d.barline){if(void 0!==d.barline[t].ending&&0==n&&(!s.combineparts||s.combineparts&&0==f))switch(d.barline[t].ending.type){case"start":let s=!0;for(let e=Number(t)+1;e<d.barline.length;e++)if(void 0!==d.barline[e].ending&&"stop"==d.barline[e].ending.type){d.barline[e].ending.type="custom_start_stop",s=!1;break}s&&(o[f][a].staves[n].setVoltaType(e.Volta.type.BEGIN,d.barline[t].ending.number+".",10),w[f].continue=!0,w[f].number=d.barline[t].ending.number);break;case"discontinue":o[f][a].staves[n].setVoltaType(e.Volta.type.MID,d.barline[t].ending.number+".",10),w[f].continue=!1,w[f].number=0;break;case"stop":o[f][a].staves[n].setVoltaType(e.Volta.type.END,d.barline[t].ending.number+".",10),w[f].continue=!1,w[f].number=0;break;case"custom_start_stop":o[f][a].staves[n].setVoltaType(e.Volta.type.BEGIN_END,d.barline[t].ending.number+".",10),w[f].continue=!1,w[f].number=0;break;default:w[f].continue=!1,w[f].number=0}else w[f].continue&&0==n&&o[f][a].staves[n].setVoltaType(e.Volta.type.MID,w[f].number+".",10);if(void 0!==d.barline[t].repeat)switch(d.barline[t].repeat.direction){case"forward":o[f][a].staves[n].setBegBarType(e.Barline.type.REPEAT_BEGIN),o[f][a].staves[n].modifiers[0].padding=3;break;case"backward":o[f][a].staves[n].setEndBarType(e.Barline.type.REPEAT_END)}else if(1==r[f]&&void 0!==d.barline[n].location)switch(d.barline[n].location){case"left":if(void 0!==d.barline[n].style)switch(d.barline[n].style){case"light-light":case"heavy-light":o[f][a].staves[n].setBegBarType(e.Barline.type.DOUBLE);break;case"none":o[f][a].staves[n].setBegBarType(e.Barline.type.NONE)}break;case"right":if(void 0!==d.barline[n].style)switch(d.barline[n].style){case"light-light":o[f][a].staves[n].setEndBarType(e.Barline.type.DOUBLE);break;case"light-heavy":o[f][a].staves[n].setEndBarType(e.Barline.type.END);break;case"none":o[f][a].staves[n].setEndBarType(e.Barline.type.NONE)}}}else w[f].continue&&0==n&&(!s.combineparts||s.combineparts&&0==f)&&o[f][a].staves[n].setVoltaType(e.Volta.type.MID,w[f].number+".",10)}if(void 0!==d.direction){let t=d.order.split(","),n=0,s=0,r=1e3;for(let i in t)if("ws"==t[i]){let t=e.Modifier.Position.ABOVE;"below"==d.direction[s].placement&&(t=e.Modifier.Position.BELOW);let n=0;void 0!==d.direction[s].staff&&(n=Number(d.direction[s].staff)-1);let i=e.TextNote.Justification.LEFT;switch(d.direction[s].words){case"D.C.":case"D.C. al":case"D.C. al Fine":case"D.S.":case"D.S. al Coda":case"D.S. al Fine":case"Fine":i=e.TextNote.Justification.RIGHT;break;case"cresc.":case"dim.":i=e.TextNote.Justification.CENTER}let l=0,c=-6;void 0!==d.direction[s].default&&void 0!==d.direction[s].default.y&&0>Number(d.direction[s].default.y)&&(t=e.Modifier.Position.BELOW,c=25),void 0!==d.direction[s].relative&&d.direction[s].relative.x,e.TextNote.Justification.LEFT==i&&(l=6,e.Modifier.Position.ABOVE==t&&(1e3==r?(c=-6,r=-6):-6==r?(c=-26,r=-26):-26==r&&(c=-46)));try{o[f][a].staves[n].setText(d.direction[s].words,t,{justification:i,shift_x:l,shift_y:c})}catch(e){}s++}else if("rl"==t[i])s++;else if("bt"==t[i])s++;else if("pl"==t[i])s++;else if("dy"==t[i])s++;else if("we"==t[i])s++;else if("od"==t[i])s++;else if("os"==t[i]){let e=d.direction[s].octaveshift;"up"==e.type||"down"==e.type?"down"==e.type?(o[f][a].osdownnum=e.number,o[f][a].osdownstart=n,o[f][a].osdownval=-1,o[f][a].osdownstaff=d.direction[s].staff-1):"up"==e.type&&(o[f][a].osupnum=e.number,o[f][a].osupstart=n,o[f][a].osupval=1,o[f][a].osupstaff=d.direction[s].staff-1):"stop"==e.type?(void 0!==o[f][a].osdownstart&&o[f][a].osdownnum==e.number&&(o[f][a].osdownstop=n),void 0!==o[f][a].osupstart&&o[f][a].osupnum==e.number&&(o[f][a].osupstop=n)):e.type,s++}else"me"==t[i]?s++:"ne"==t[i]&&n++}for(let e=0;e<r[f];e++)o[f][a].staves[e].setContext(s.combineparts?t[0]:t[f]).draw();g[f]-=s.staveheight*r[f],_[f]+=o[f][a].size;const C=Number(a)+1;void 0!==o[f][C]&&o[f][C].newsystem&&(_[f]=49,s.combineparts?(g[f]=0==f?k+g[p]+A[p]:g[p]+A[p],void 0!==l[f].abbreviation&&(_[f]+=s.abbrsize)):2==r[f]?g[f]+=s.systemheight.s2:g[f]+=s.systemheight.s1);let E=!1,T=0,N=0;if(s.combineparts){if(0==a&&void 0!==l[f].name?o[f][a].staves[0].setText(l[f].name,e.Modifier.Position.LEFT).setContext(t[0]).draw():o[f][a].newsystem&&void 0!==l[f].abbreviation&&o[f][a].staves[0].setText(l[f].abbreviation,e.Modifier.Position.LEFT).setContext(t[0]).draw(),(0==a||o[f][a].newsystem)&&(i==f&&new e.StaveConnector(o[0][a].staves[0],o[i][a].staves[o[i][a].staves.length-1]).setType(e.StaveConnector.type.SINGLE_LEFT).setContext(t[0]).draw(),u[f].enable)){let n=e.StaveConnector.type.BRACKET;switch(u[f].symbol){case"brace":n=e.StaveConnector.type.BRACE;break;case"line":n=e.StaveConnector.type.SINGLE}new e.StaveConnector(o[u[f].start][a].staves[0],o[u[f].stop][a].staves[o[u[f].stop][a].staves.length-1]).setType(n).setContext(t[0]).draw()}c[f].enable&&(E=!0,T=c[f].start,N=c[f].stop)}let x=null,S=null;if(2==r[f]||E){if(2!=r[f]||0!=a&&!o[f][a].newsystem||(new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.BRACE).setContext(s.combineparts?t[0]:t[f]).draw(),new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.SINGLE_LEFT).setContext(s.combineparts?t[0]:t[f]).draw()),void 0!==d.barline)for(let t in d.barline)switch(d.barline[t].location){case"left":if(void 0!==d.barline[t].style)switch(x=E?new e.StaveConnector(o[T][a].staves[0],o[N][a].staves[o[N][a].staves.length-1]).setType(e.StaveConnector.type.SINGLE_LEFT):new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.SINGLE_LEFT),d.barline[t].style){case"light-light":x.setType(e.StaveConnector.type.THIN_DOUBLE);break;case"heavy-light":x.setType(e.StaveConnector.type.BOLD_DOUBLE_LEFT),E?x.setXShift(o[T][a].staves[0].start_x-o[T][a].staves[0].x-5.5):x.setXShift(o[f][a].staves[0].start_x-o[f][a].staves[0].x-5.5);break;case"none":x.setType(e.StaveConnector.type.NONE)}break;case"right":if(void 0!==d.barline[t].style)switch(S=E?new e.StaveConnector(o[T][a].staves[0],o[N][a].staves[o[N][a].staves.length-1]).setType(e.StaveConnector.type.SINGLE_RIGHT):new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.SINGLE_RIGHT),d.barline[t].style){case"light-light":S.setType(e.StaveConnector.type.THIN_DOUBLE);break;case"light-heavy":S.setType(e.StaveConnector.type.BOLD_DOUBLE_RIGHT);break;case"none":S.setType(e.StaveConnector.type.NONE)}}null==x&&(x=E?new e.StaveConnector(o[T][a].staves[0],o[N][a].staves[o[N][a].staves.length-1]).setType(e.StaveConnector.type.SINGLE_LEFT):new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.SINGLE_LEFT)),null==S&&(S=E?new e.StaveConnector(o[T][a].staves[0],o[N][a].staves[o[N][a].staves.length-1]).setType(e.StaveConnector.type.SINGLE_RIGHT):new e.StaveConnector(o[f][a].staves[0],o[f][a].staves[1]).setType(e.StaveConnector.type.SINGLE_RIGHT)),x.setContext(s.combineparts?t[0]:t[f]).draw(),S.setContext(s.combineparts?t[0]:t[f]).draw()}o[f][a].lconnector=x,o[f][a].rconnector=S}for(let a in n.part){const i=n.part[a].measure,l=new Array,c=new Array,u=new Array,f=new Array,d=new Array,p=new Array,h=new Array,y=new Array(r[a]);let v=null,m=null,b=null,w=null,g={continue:!1,number:0};for(let e=0;e<r[a];e++)y[e]={has:!1,val:0,staff:0,end:null};for(let n in i){const r=i[n],_=new Array,A=Number(r.note.length);let k=0;for(let e=0;e<A;e++)_[Number(r.note[e].voice)]=!0,void 0!==r.note[e].lyric&&r.note[e].lyric.length>k&&(k=r.note[e].lyric.length);const C=new Array;for(let e=1;e<_.length;e++)null!=_[e]&&C.push(e);const E=new Array(C.length),T=new Array,N=new Array(C.length),x=new Array(k),S=new Array,B=new Array,D=o[a][n].clef_note.slice(0),G={};if(o[a][n].newsystem){for(let e in l)l[e].newsystem=!0;for(let e in c)c[e].newsystem=!0;for(let e in u)u[e].newsystem=!0}for(let t=0;t<C.length;t++){const i=C[t].toString(),u=o[a][n].times[0].split("/"),f=u[0]||4,h=u[1]||4;try{N[t]=new e.Voice({num_beats:f,beat_value:h,resolution:e.RESOLUTION})}catch(e){}const v=new Array,m=new Array(k),b=new Array,w=new Array,_=new Array;let F=new Array,I=(new Array(A),new Array);for(let e=0;e<k;e++)m[e]=new Array;0==t&&(G.clef=o[a][n].clef.slice(0),G.pos=o[a][n].clef_pos.slice(0),G.note=o[a][n].clef_note.slice(0),G.count=Number(G.pos.length));for(let u=0;u<A;u++){const f=r.note[u];if(i==f.voice&&void 0===f.chord){void 0!==f.staff?E[t]=Number(f.staff)-1:E[t]=0;let h={},C=null,N=null;if(0<G.count)for(let n in G.pos)if(0<u&&u==G.pos[n]){if(C=G.note[n],G.clef[E[t]]=C,G.note.splice(n,1),G.pos.splice(n,1),G.count=Number(G.pos.length),0<D.length){const t=new e.ClefNote(C,"small");N=new e.NoteSubGroup([t]),D.splice(n,1)}break}h.clef=G.clef[E[t]],h.duration=Duration.parseDuration(f.type),void 0!==f.dot&&(h.duration=h.duration+"d"),void 0!==f.rest&&(h.duration=h.duration+"r",void 0!==o[a][n].osdownstart&&u==o[a][n].osdownstart&&(y[E[t]].has=!0,y[E[t]].val=o[a][n].osdownval,y[E[t]].staff=o[a][n].osdownstaff),void 0!==o[a][n].osupstart&&u==o[a][n].osupstart&&(y[E[t]].has=!0,y[E[t]].val=o[a][n].osupval,y[E[t]].staff=o[a][n].osupstaff),void 0!==o[a][n].osdownstop&&u==o[a][n].osdownstop&&(y[E[t]].has=!1,y[E[t]].val=0,y[E[t]].staff=0,y[E[t]].stop=null),void 0!==o[a][n].osupstop&&u==o[a][n].osupstop&&(y[E[t]].has=!1,y[E[t]].val=0,y[E[t]].staff=0,y[E[t]].stop=null)),void 0!==f.stem&&(h.stem_direction=1,"down"==f.stem&&(h.stem_direction=-1));let x=0;if(h.accidental=new Array,h.accidental_number=new Array,h.keys=["B/4"],"bass"==h.clef&&(h.keys=["D/3"]),void 0!==f.pitch)for(let s=u;s<A;s++){const i=r.note[s];let l=null;if(u==s){if(l=i.pitch.octave,void 0!==o[a][n].osdownstart&&u==o[a][n].osdownstart&&(y[E[t]].has=!0,y[E[t]].val=o[a][n].osdownval,y[E[t]].staff=o[a][n].osdownstaff),void 0!==o[a][n].osupstart&&u==o[a][n].osupstart&&(y[E[t]].has=!0,y[E[t]].val=o[a][n].osupval,y[E[t]].staff=o[a][n].osupstaff),y[E[t]].has&&y[E[t]].staff==E[t]&&(l=Number(l)+y[E[t]].val),h.keys=[i.pitch.step+"/"+l],void 0!==o[a][n].osdownstop&&u==o[a][n].osdownstop){y[E[t]].stop=o[a][n].osdownstop;for(let e=s+1;e<A&&void 0!==r.note[e].chord;e++)y[E[t]].stop=e;u==y[E[t]].stop&&(y[E[t]].has=!1,y[E[t]].val=0,y[E[t]].staff=0,y[E[t]].stop=null)}if(void 0!==o[a][n].osupstop&&u==o[a][n].osupstop){y[E[t]].stop=o[a][n].osupstop;for(let e=s+1;e<A&&void 0!==r.note[e].chord;e++)y[E[t]].stop=e;u==y[E[t]].stop&&(y[E[t]].has=!1,y[E[t]].val=0,y[E[t]].staff=0,y[E[t]].stop=null)}}else{if(void 0===i.chord||void 0===i.pitch)break;l=i.pitch.octave,y[E[t]].has&&y[E[t]].staff==E[t]&&(l=Number(l)+y[E[t]].val),h.keys.push(i.pitch.step+"/"+l),s==y[E[t]].stop&&(y[E[t]].has=!1,y[E[t]].val=0,y[E[t]].stop=null),x++}if(void 0!==i.accidental){h.accidental_number.push(x);const t=Accidental.parseAccidental(i.accidental);h.accidental.push(new e.Accidental(t))}}if(void 0!==f.beam)for(let e in f.beam)if("begin"==f.beam[e].type){const t=b.length;b[t]=new Array,b[t].push(u);let n=!1;for(let s=Number(u)+1;s<A&&!n;s++){const o=r.note[s];if(i==o.voice&&void 0!==o.beam)for(let r in o.beam)if(f.beam[e].number==o.beam[r].number){"continue"==o.beam[r].type?b[t].push(s):"end"==o.beam[r].type&&(b[t].push(s),n=!0);break}}}else"forward hook"==f.beam[e].type||f.beam[e].type;if(void 0!==f.tuplet)for(let e in f.tuplet)if("start"==f.tuplet[e].type&&f.tuplet[e].show_number){const t=w.length;w[t]=new Array,w[t].push(u),_[t]={num_notes:f.time.actual_notes,notes_occupied:f.time.normal_notes,location:1==h.stem_direction?-1:1,bracketed:f.tuplet[e].bracket,bracketed:!1};let n=!1;for(let s=Number(u)+1;s<A&&!n;s++){const o=r.note[s];if(i==o.voice&&void 0===o.chord&&void 0===o.grace&&o.print&&(w[t].push(s),void 0!==o.tuplet))for(let t in o.tuplet)if(f.tuplet[e].number==o.tuplet[t].number){"stop"==o.tuplet[t].type&&(n=!0);break}}}if(void 0!==f.nts){let t=null,n=null,s=0;const r=1==h.stem_direction?"below":"above";if(void 0!==f.nts.fermata)t="above"==r?"a@a":"a@u";else if(void 0!==f.nts.articulations){const e=f.nts.articulations;void 0!==e.staccato?t="a.":void 0!==e.staccatissimo?t="av":void 0!==e.accent?t="a>":void 0!==e.tenuto?t="a-":void 0!==e.marcato&&(t="a^")}else if(void 0!==f.nts.technical){const n=f.nts.technical;void 0!==n.up_bow?t="a|":void 0!==n.down_bow?t="am":void 0!==n.fingering&&(h.handfinger=new e.FretHandFinger(n.fingering.number).setPosition(r))}if(null!=t&&(h.articulation=new e.Articulation(t).setPosition(r)),void 0!==f.nts.ornaments){const e=f.nts.ornaments;void 0!==e.trill_mark?n="tr":void 0!==e.mordent?n="mordent":void 0!==e.inverted_mordent?n="mordent_inverted":void 0!==e.turn?n="turn":void 0!==e.tremolo?"start"==e.tremolo.type?(n="tremolo",s=e.tremolo.number,g.number=s,g.continue=!0):"stop"==e.tremolo.type?(n="tremolo",s=e.tremolo.number,g.number=0,g.continue=!1):"single"==e.tremolo.type&&(n="tremolo",s=e.tremolo.number):e.wavy_line}null!=n&&(h.ornament="tremolo"==n?new e.Tremolo(s):new e.Ornament(n)),void 0!==f.nts.arpeggiate&&(h.arpeggiate=new e.Stroke(e.Stroke.Type.ROLL_UP,{}),void 0!==f.nts.arpeggiate.direction&&"up"==f.nts.arpeggiate.direction&&(h.arpeggiate=new e.Stroke(e.Stroke.Type.ROLL_DOWN,{})))}else g.continue&&(h.ornament=new e.Tremolo(g.number));if(f.print)if(void 0!==f.grace){s.slashon&&(h.slash=f.grace.slash);let t=null;try{t=new e.GraceNote(h)}catch(e){}if(void 0!==f.dot)for(let e=0;e<f.dot.cnt;e++)t.addDotToAll();if(void 0!==h.articulation&&t.addArticulation(0,h.articulation),void 0!==h.ornament&&t.addModifier(0,h.ornament),void 0!==h.handfinger&&t.addModifier(0,h.handfinger),void 0!==h.arpeggiate&&t.addModifier(0,h.arpeggiate),0<h.accidental.length&&t.addAccidental(0,h.accidental[0]),null!=N&&t.addModifier(0,N),F.push(t),void 0!==f.tie){const e=f.pitch.step+"/"+f.pitch.octave;for(let n in f.tie)if("start"==f.tie[n].type)l.push({first_note:t,first_indices:[0],key:e,voice:f.voice,newsystem:!1,done:!1});else{for(let n=l.length-1;0<=n;n--)if(!l[n].done&&l[n].key==e){l[n].newsystem?(l[n].done=!0,l.push({last_note:t,last_indices:[0],done:!0})):(l[n].done=!0,l[n].last_note=t,l[n].last_indices=[0]);break}}}if(void 0!==f.slur)for(let e in f.slur)if("start"==f.slur[e].type)c.push({first_note:t,last_note:null,number:f.slur[e].number,voice:f.voice,newsystem:!1,done:!1});else{for(let n=c.length-1;0<=n;n--)if(!c[n].done&&c[n].number==f.slur[e].number){c[n].newsystem?(c[n].done=!0,c.push({first_note:null,last_note:t,done:!0})):(c[n].done=!0,c[n].last_note=t);break}}}else{try{T[u]=new e.StaveNote(h)}catch(e){}if(void 0!==f.dot)for(let e=0;e<f.dot.cnt;e++)T[u].addDotToAll();if(void 0!==h.articulation&&T[u].addArticulation(0,h.articulation),void 0!==h.ornament&&T[u].addModifier(0,h.ornament),void 0!==h.handfinger&&T[u].addModifier(0,h.handfinger),void 0!==h.arpeggiate&&T[u].addModifier(0,h.arpeggiate),v.push(T[u]),null!=N&&T[u].addModifier(0,N),0<F.length){try{T[u].addModifier(0,new e.GraceNoteGroup(F,!1).beamNotes())}catch(e){}F=new Array}for(let e in h.accidental)T[u].addAccidental(h.accidental_number[e],h.accidental[e]);x=0;for(let e=u;e<A;e++){const t=r.note[e];if(u<e){if(void 0===t.chord||void 0===t.pitch)break;x++}if(void 0!==t.tie){const e=t.pitch.step+"/"+t.pitch.octave;for(let n in t.tie)if("start"==t.tie[n].type)l.push({first_note:T[u],first_indices:[x],key:e,voice:t.voice,newsystem:!1,done:!1});else{for(let t=l.length-1;0<=t;t--)if(!l[t].done&&l[t].key==e){l[t].newsystem?(l[t].done=!0,l.push({last_note:T[u],last_indices:[x],done:!0})):(l[t].done=!0,l[t].last_note=T[u],l[t].last_indices=[x]);break}}}if(void 0!==t.slur)for(let e in t.slur)if("start"==t.slur[e].type)c.push({first_note:T[u],last_note:null,number:t.slur[e].number,voice:t.voice,newsystem:!1,done:!1});else{for(let n=c.length-1;0<=n;n--)if(!c[n].done&&c[n].number==t.slur[e].number){c[n].newsystem?(c[n].done=!0,c.push({first_note:null,last_note:T[u],done:!0})):(c[n].done=!0,c[n].last_note=T[u]);break}}if(void 0!==t.nts){if(void 0!==t.nts.glissando){const e=t.nts.glissando;if("start"==e.type)d.push({first_note:T[u],first_indices:[x],number:e.number,line_type:e.line_type,text:e.text,done:!1});else{for(let t=d.length-1;0<=t;t--)d[t].done||d[t].number!=e.number||(d[t].done=!0,d[t].last_note=T[u],d[t].last_indices=[x])}}if(void 0!==t.nts.ornaments&&void 0!==t.nts.ornaments.wavy_line){const e=t.nts.ornaments.wavy_line;if("start"==e.type)p.push({start:T[u],number:e.number,done:!1});else{for(let t=p.length-1;0<=t;t--)p[t].done||p[t].number!=e.number||(p[t].done=!0,p[t].stop=T[u])}}}}}else{try{T[u]=new e.GhostNote(h)}catch(e){}v.push(T[u])}const S=12;let B=new Array(k),L=new Array(k);for(let t=0;t<k;t++){if(L[t]={text:"",line:S,clef:h.clef,keys:h.keys,duration:h.duration,smooth:!0,justification:e.TextNote.Justification.LEFT,font:{family:"Alegreya",size:12,weight:""}},void 0!==f.lyric)for(let n=0;n<f.lyric.length;n++){if(t==Number(f.lyric[n].number)-1&&(L[t].text=f.lyric[n].text,L[t].line=S+2*t,void 0!==f.lyric[n].syllabic&&("begin"!=f.lyric[n].syllabic&&"middle"!=f.lyric[n].syllabic||(L[t].text+="-")),void 0!==f.lyric[n].justify))switch(f.lyric[n].justify){case"center":L[t].justification=e.TextNote.Justification.CENTER;break;case"right":L[t].justification=e.TextNote.Justification.RIGHT}}void 0===f.grace?(0<I.length&&(L[t].text=I[t].text,L[t].justification=I[t].justification,I=new Array),B[t]=new e.TextNote(L[t]),B[t].setStave(o[a][n].staves[0]),m[t].push(B[t])):I.push(L[t])}}}let L=0;const M=new Array(b.length);for(let t in b){for(let e in b[t])null==M[L]&&(M[L]=new Array),M[L].push(T[b[t][e]]);S.push(new e.Beam(M[L])),L++}let O=0;const V=new Array(w.length);for(let t in w){for(let e in w[t])null==V[O]&&(V[O]=new Array),V[O].push(T[w[t][e]]);B.push(new e.Tuplet(V[O],_[O])),O++}try{N[t].setMode(e.Voice.Mode.SOFT),N[t].addTickables(v);for(let t=0;t<k;t++)x[t]=new e.Voice({num_beats:f,beat_value:h,resolution:e.RESOLUTION}),x[t].setMode(e.Voice.Mode.SOFT),x[t].addTickables(m[t])}catch(e){}}if(void 0!==r.direction){let t=r.order.split(","),n=0,s=0;for(let o in t)if("we"==t[o]){const e=r.direction[s].wedge;if("crescendo"==e.type||"diminuendo"==e.type){const t="crescendo"==e.type?1:2;let s=T[n];if(void 0===s)for(let e=n+1;e<T.length;e++)if(void 0!==T[e]){s=T[e];break}u.push({type:t,number:e.number,first_note:s,last_note:null,newsystem:!1,done:!1})}else if("stop"==e.type)for(let t=u.length-1;0<=t;t--)if(!u[t].done&&u[t].number==e.number){if(u[t].newsystem)u.splice(t,1);else{if(0==n){for(let e=v.length-1;0<=e;e--)if(void 0!==v[e]){u[t].last_note=v[e],u[t].done=!0;break}}else for(let e=n-1;0<=e;e--)if(void 0!==T[e]){u[t].last_note=T[e],u[t].done=!0;break}u[t].done||u.splice(t,1)}break}s++}else if("pl"==t[o]){let e=r.direction[s].pedal;if("start"==e.type)m=new Array,m.push(T[n]);else if("stop"==e.type){let t="yes"==e.line;m.push(T[n]),f.push({notes:m,line:t}),m=null}s++}else if("dy"==t[o]){const t=new e.Annotation(r.direction[s].dynamics);t.setFont("Alegreya",14,"bold italic"),t.setJustification(e.Annotation.Justify.CENTER),t.setVerticalJustification(e.Annotation.VerticalJustify.BOTTOM);for(let e=n;e<Number(r.note.length);e++)if(void 0!==T[e]&&"GhostNote"!=T[e].attrs.type){T[e].addAnnotation(0,t);break}s++}else if("ws"==t[o])s++;else if("rl"==t[o])s++;else if("me"==t[o])s++;else if("bt"==t[o])s++;else if("od"==t[o])s++;else if("os"==t[o]){let t=r.direction[s].octaveshift,o={start:T[n],stop:null,number:t.number,text:t.size,font:{family:"Serif",size:15,weight:"italic"}};if("up"==t.type||"down"==t.type)"down"==t.type?(w=o,w.superscript="va",w.position=e.TextBracket.Positions.TOP):"up"==t.type&&(b=o,b.superscript="vb",b.position=e.TextBracket.Positions.BOTTOM);else if("stop"==t.type){if(null==w&&null==b)continue;null!=w&&w.number==t.number&&(w.stop=T[n],h.push(new e.TextBracket(w).setLine(3)),w=null),null!=b&&b.number==t.number&&(b.stop=T[n],h.push(new e.TextBracket(b).setLine(3)),b=null)}else t.type;s++}else"ne"==t[o]&&n++}try{let t=new e.Formatter;for(let e=0;e<N.length;e++)t.joinVoices([N[e]]);for(let e=0;e<x.length;e++)t.joinVoices([x[e]]);let s=15+12*o[a][n].kscnt[0]+20*o[a][n].tmcnt;0==n||o[a][n].newsystem?(s+=30,1e4==o[a][n].clef_pos[o[a][n].clef_pos.length-1]&&(s+=20)):0<o[a][n].clef_pos.length&&(s+=20,1e4==o[a][n].clef_pos[o[a][n].clef_pos.length-1]&&(s+=10)),t.format(N,o[a][n].size-s);for(let e=0;e<x.length;e++)t.format([N[0],x[e]],o[a][n].size-s)}catch(e){}for(let e in N)try{N[e].draw(s.combineparts?t[0]:t[a],o[a][n].staves[E[e]])}catch(e){}for(let e in x)try{x[e].setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}S.forEach((function(e){try{e.setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),B.forEach((function(e){try{e.setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),o[a][n].pos=E,o[a][n].voices=N,o[a][n].lyrics=x,o[a][n].beams=S,o[a][n].tuplets=B,v=T}l.forEach((function(n){try{new e.StaveTie(n).setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),s.sluron&&c.forEach((function(n){try{new e.Curve(n.first_note,n.last_note,{cps:[{x:0,y:20},{x:0,y:20}]}).setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),u.forEach((function(n){try{new e.StaveHairpin({first_note:n.first_note,last_note:n.last_note},n.type).setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),p.forEach((function(n){try{new e.VibratoBracket(n).setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),d.forEach((function(n){try{let r=new e.StaveLine(n);void 0!==n.text&&(r.setText(n.text),r.setFont({family:"Alegreya",size:8,weight:"lighter italic"})),r.setContext(s.combineparts?t[0]:t[a]),r.applyFontStyle(),r.draw()}catch(e){}})),f.forEach((function(n){try{let r=new e.PedalMarking(n.notes);n.line?r.setStyle(e.PedalMarking.Styles.MIXED):r.setStyle(e.PedalMarking.Styles.TEXT),r.setLine(4),r.setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),h.forEach((function(e){try{e.setContext(s.combineparts?t[0]:t[a]).draw()}catch(e){}})),o[a].ties=l,o[a].slurs=c,o[a].wedges=u,o[a].vibs=p,o[a].glisss=d,o[a].pedals=f,o[a].octaveshifts=h}return o}setPartAttr(e,t){const n=new Array(t),s=new Array(t),r=new Array(t);let o=0,a=0;for(let t in e){if(void 0===s[o]&&(s[o]={enable:!1,number:-1,start:-1,stop:-1}),void 0===r[o]&&(r[o]={enable:!1,number:-1,symbol:"none",start:-1,stop:-1}),void 0!==e[t].partgroup)switch(a=void 0!==e[t].partgroup.number?Number(e[t].partgroup.number)-1:0,e[t].partgroup.type){case"start":"yes"==e[t].partgroup.barline&&(s[o]={enable:!1,number:a,start:o,stop:0}),"none"!=e[t].partgroup.symbol&&(r[o]={enable:!1,number:a,symbol:e[t].partgroup.symbol,start:o,stop:0});break;case"stop":for(let e in s)if(a==s[e].number){let t=Number(o)-1;s[t].number=s[e].number,s[t].start=s[e].start,s[t].enable=!0,s[t].stop=t;break}for(let e in r)if(a==r[e].number){let t=Number(o)-1;r[t].number=r[e].number,r[t].start=r[e].start,r[t].symbol=r[e].symbol,r[t].enable=!0,r[t].stop=t;break}}void 0!==e[t].scorepart&&(n[o]={name:void 0,abbreviation:void 0},void 0!==e[t].scorepart.name&&(n[o].name=e[t].scorepart.name),void 0!==e[t].scorepart.abbreviation&&(n[o].abbreviation=e[t].scorepart.abbreviation),o++)}return[n,s,r]}getY(e,t){const n=t.split("-");return e[n[0]][n[1]].top[n[2]]}}class Newcombine{constructor(){}static redraw(e,t,n,s){const r=n.length,o=n[0].length;let a,i,l=new Array(r).fill(!0),c=-1,u=new Array(r),f=new Array(r),d=new Array(r),p=new Array(r),h=new Array(r),y=new Array(r),v=s.lineheight;for(let e=0;e<r;e++)u[e]={enable:!1,start:-1,stop:-1},f[e]={enable:!1,start:-1,stop:-1,length:0};void 0!==s.pickparts&&s.pickparts.length>0&&(l=s.pickparts);for(let e in l)if(l[e]){y[e]=i,p[e]=49,-1==c&&(c=e),i=a=e;for(let t=0;t<r;t++)if(n.partbarlines[t].enable){e>=n.partbarlines[t].start&&e<=n.partbarlines[t].stop&&(u[t].enable=!0,-1==u[t].start&&(u[t].start=e),u[t].stop=e);break}for(let t=0;t<r;t++)if(n.partsymbols[t].enable){e>=n.partsymbols[t].start&&e<=n.partsymbols[t].stop&&(f[t].enable=!0,-1==f[t].start&&(f[t].start=e),f[t].stop=e,f[t].length++);break}}y[c]=a;for(let e=0;e<r;e++)u[e].enable&&u[e].stop!=e&&(u[u[e].stop]={enable:!0,start:u[e].start,stop:u[e].stop},u[e]={enable:!1,start:-1,stop:-1}),f[e].enable&&f[e].stop!=e&&(f[f[e].stop]={enable:!0,start:f[e].start,stop:f[e].stop,length:f[e].length},f[e]={enable:!1,start:-1,stop:-1,length:0});for(let i=0;i<o;i++)for(let o in n)if(l[o]){const l=n[o][i].staves.length;if(0==i&&(h[o]=s.staveheight*l,d[o]=o==c?s.topmargin:d[y[o]]+h[y[o]],void 0!==n.partnames[o].name&&(p[o]+=s.namesize)),0!=c){if(o==c){n[c][i].staves[0].setMeasure(n[0][i].staves[0].measure);const e=n[0][i].staves[0].getModifiers();for(let t in e)"voltas"==e[t].getCategory()&&n[c][i].staves[0].addModifier(e[t])}}else if(o!=c){n[o][i].staves[0].setMeasure("");const e=n[o][i].staves[0].getModifiers();for(let t=e.length-1;t>=0;t--)"voltas"==e[t].getCategory()&&n[o][i].staves[0].getModifiers().splice(t,1)}for(let e=0;e<l;e++)n[o][i].staves[e].setX(p[o]),n[o][i].staves[e].setY(d[o]),n[o][i].staves[e].setWidth(n[o][i].size),d[o]+=s.staveheight,n[o][i].staves[e].setContext(t).draw();d[o]-=s.staveheight*l,p[o]+=n[o][i].size;const m=Number(i)+1;void 0!==n[o][m]&&n[o][m].newsystem&&(p[o]=49,d[o]=o==c?v+d[y[o]]+h[y[o]]:d[y[o]]+h[y[o]],void 0!==n.partnames[o].abbreviation&&(p[o]+=s.abbrsize));let b=!1,w=0,g=0;(0==i||n[o][i].newsystem)&&(o==a&&new e.StaveConnector(n[c][i].staves[0],n[a][i].staves[n[a][i].staves.length-1]).setType(e.StaveConnector.type.SINGLE_LEFT).setContext(t).draw(),f[o].enable&&f[o].length>1&&new e.StaveConnector(n[f[o].start][i].staves[0],n[f[o].stop][i].staves[n[f[o].stop][i].staves.length-1]).setType(e.StaveConnector.type.BRACKET).setContext(t).draw()),u[o].enable&&(b=!0,w=u[o].start,g=u[o].stop),(2==l||b)&&(2!=l||0!=i&&!n[o][i].newsystem||(new e.StaveConnector(n[o][i].staves[0],n[o][i].staves[1]).setType(e.StaveConnector.type.BRACE).setContext(t).draw(),new e.StaveConnector(n[o][i].staves[0],n[o][i].staves[1]).setType(e.StaveConnector.type.SINGLE_LEFT).setContext(t).draw()),b?(n[o][i].lconnector=n[r-1][i].lconnector,n[o][i].rconnector=n[r-1][i].rconnector,n[o][i].lconnector.top_stave=n[o][i].rconnector.top_stave=n[w][i].staves[0],n[o][i].lconnector.bottom_stave=n[o][i].rconnector.bottom_stave=n[g][i].staves[n[g][i].staves.length-1]):2==l&&(n[o][i].lconnector.top_stave=n[o][i].rconnector.top_stave=n[o][i].staves[0],n[o][i].lconnector.bottom_stave=n[o][i].rconnector.bottom_stave=n[o][i].staves[1]),n[o][i].lconnector.setContext(t).draw(),n[o][i].rconnector.setContext(t).draw())}for(let r in n)if(l[r]){const a=n[r].ties,i=n[r].slurs,l=n[r].wedges,c=n[r].vibs,u=n[r].glisss,f=n[r].pedals,d=n[r].octaveshifts;for(let e=0;e<o;e++){const s=n[r][e].voices,o=n[r][e].pos,a=n[r][e].lyrics,i=n[r][e].beams,l=n[r][e].tuplets;for(let a in s)try{s[a].draw(t,n[r][e].staves[o[a]])}catch(e){}for(let e in a)try{a[e].setContext(t).draw()}catch(e){}i.forEach((function(e){try{e.setContext(t).draw()}catch(e){}})),l.forEach((function(e){try{e.setContext(t).draw()}catch(e){}}))}a.forEach((function(n){try{new e.StaveTie(n).setContext(t).draw()}catch(e){}})),s.sluron&&i.forEach((function(n){try{new e.Curve(n.first_note,n.last_note,{cps:[{x:0,y:20},{x:0,y:20}]}).setContext(t).draw()}catch(e){}})),l.forEach((function(n){try{new e.StaveHairpin({first_note:n.first_note,last_note:n.last_note},n.type).setContext(t).draw()}catch(e){}})),c.forEach((function(n){try{new e.VibratoBracket(n).setContext(t).draw()}catch(e){}})),u.forEach((function(n){try{let s=new e.StaveLine(n);void 0!==n.text&&(s.setText(n.text),s.setFont({family:"Alegreya",size:8,weight:"lighter italic"})),s.setContext(t),s.applyFontStyle(),s.draw()}catch(e){}})),f.forEach((function(n){try{let s=new e.PedalMarking(n.notes);n.line?s.setStyle(e.PedalMarking.Styles.MIXED):s.setStyle(e.PedalMarking.Styles.TEXT),s.setLine(4),s.setContext(t).draw()}catch(e){}})),d.forEach((function(e){try{e.setContext(t).draw()}catch(e){}}))}return n}}class Measure{constructor(e,t,n,s){this._VF=e,this._target=t,this._xmldata=n,this._options=s,this._height=200,this._width=s.mswidth}searchMelodys(e,t,n){const s=this.setHeadClef(),r=this._options.part,o=this._options.mstart,a=this._options.mend,i=this._options.count;let l=new Array,c=new Array,u=new Array(i),f=new Array,d=!0,p=0,h=0;for(let e=o;e<=a;e++){const t=this._xmldata.part[r].measure[e];if(u[h]=new Array,void 0!==t.melody){const e=t.melody;try{for(let t in e){if(!d)break;if(null!=e[t]){let n=e[t].pitchs.split("|");p=t;for(let e in n){let t=n[e];if(""!=t){d=!1;const[e,n,s]=t.split(":"),r=this.convMidiNum(e,Number(n),s);c.push(r),u[h].push(r)}}}}}catch(e){}d=!0}l.push(c.length),f.push({pms:r+"-"+e+"-0-"+p,nelist:""}),h++}return"1"==t&&(f=this.searchByPitch(e,c,l,f,n)),"2"==t&&(f=this.searchByBeat(e,u,f,s)),"3"==t&&(f=this.searchByDownbeat(e,u,f,s,"week")),"4"==t&&(f=this.searchByDownbeat(e,u,f,s,"strong")),[s,f]}setHeadClef(){const e=new Array(this._xmldata.part.length);for(let t in this._xmldata.part){const n=this._xmldata.part[t].measure,s=this._xmldata.part[0].measure.length;e[t]={},e[t].stavecnt=1;for(let r in n){const o=n[r];void 0===e[t][r]&&(e[t][r]={}),e[t][r].times=new Array,e[t][r].tmcnt=new Array,e[t][r].keys=new Array,e[t][r].kscnt=new Array,void 0===e[t][r].clef&&(e[t][r].clef=new Array),e[t][r].clef_pos=new Array,e[t][r].clef_note=new Array,e[t][r].clef_staff=new Array;let a=o.order.split(","),i=-1,l=0;if(void 0!==o.attr)for(let n in o.attr)if(0==r&&void 0!==o.attr[0].staves&&(e[t].stavecnt=Number(o.attr[0].staves)),void 0!==o.attr[n].clef){const c=a.length;for(let n in a)if("ne"==a[n]&&l++,"cf"==a[n]){n=Number(n),i=c==n+2||"bp"==a[n+1]?1e4:l,a.splice(0,Number(n)+1),e[t][r].clef_pos.push(i);break}for(let a in o.attr[n].clef){let i=0;if(void 0!==o.attr[n].clef[a].number&&(i=Number(o.attr[n].clef[a].number)-1),0==e[t][r].clef_pos[0])e[t][r].clef[i]=Clef.parseClef(o.attr[n].clef[a]);else{r=Number(r),s>r+1&&void 0===e[t][r+1]&&(e[t][r+1]={},e[t][r+1].clef=new Array);const l=Clef.parseClef(o.attr[n].clef[a]);e[t][r].clef_note.push(l),e[t][r].clef_staff.push(i),s>r+1&&(e[t][r+1].clef[i]=l)}}}for(let n=0;n<e[t].stavecnt;n++)void 0===e[t][r].clef[n]&&(e[t][r].clef[n]=e[t][r-1].clef[n]),void 0!==o.attr&&void 0!==o.attr[0].time?(e[t][r].times[n]=Time.parseTime(o.attr[0].time),e[t][r].tmcnt=1):(e[t][r].times[n]=e[t][r-1].times[n],e[t][r].tmcnt=0),void 0!==o.attr&&void 0!==o.attr[0].key?(e[t][r].keys[n]=Key.parseKey(o.attr[0].key),e[t][r].kscnt[n]=Key.ksCount(e[t][r].keys[n])):(e[t][r].keys[n]=e[t][r-1].keys[n],e[t][r].kscnt[n]=Key.ksCount(e[t][r].keys[n]))}}return e}searchByPitch(e,t,n,s,r){const o=this._options.part,a=this._options.mstart,i=this._options.mend;let l,c,u=new Array,f=s[0].pms.split("-")[3],d=[];for(let e=0;e<t.length-1;e++)u.push(parseInt(t[e+1])-parseInt(t[e]));let p=u.join("|"),h=p.indexOf(e,r);if(h>-1){let t=e.split("|").length,r=0;l=0==p.substr(0,h).split("|").length?0:p.substr(0,h).split("|").length-1,c=Number(l)+Number(t)+1;let u=0;for(let e=a;e<=i;e++){const a=this._xmldata.part[o].measure[e];if(t<=r-1)s[u].nelist=d;else if(void 0!==a.melody){const e=a.melody;c>n[u]?(d=d.concat(e[f].nnum.split("|").slice(l,n[u])),l=0,c-=n[u]):d=d.concat(e[f].nnum.split("|").slice(l,c)),r+=d.length,s[u].nelist=d,d=[],u++}}}return s}searchByBeat(e,t,n,s){const r=this._options.part,o=this._options.mstart,a=this._options.mend;let i,l,c=new Array,u=new Array,f=new Array,d=new Array,p=0,h=n[0].pms.split("-")[3],y=[];for(let e=o;e<=a;e++){const n=this._xmldata.part[r].measure[e],o=n.melody,a=n.note;let i=new Array,l=n.backup[0].duration,d=s[r][e].times[0].split("/")[1],y=-1,v=0,m=!1,b=o[h].nnum.split("|").length,w=o[h].nnum.split("|");for(let e in w){if(e==b-1)break;let t=w[e],n=Time.parseNumType(a[t].type),s=a[t].duration;if(m=!(!m&&void 0===a[t].tuplet),m){if(v+=Number(a[t].duration),void 0===a[t].tuplet||"stop"!=a[t].tuplet[0].type)continue;m=!1,s=v/a[t].time.normal_notes}if(n%d==0){y=s*(n/d);break}}if(-1==y&&1024==l&&(y=l/d),y>-1){let e=0,n=0;for(;e!=l;)i.push(e),e+=Number(y);for(let e in w){if(e==b-1)break;let s=w[e],r=a[s].duration;i.includes(n)&&(u.push(t[p][e]),void 0!==a[s].rest?e!=b-2&&c.push(Number(s)+1):c.push(s)),n+=Number(r)}f.push(u.length)}p++}for(let e=0;e<u.length-1;e++)d.push(parseInt(u[e+1])-parseInt(u[e]));let v=d.join("|"),m=v.indexOf(e);if(m>-1){let t=e.split("|").length,s=0;i=0==v.substr(0,m).split("|").length?0:v.substr(0,m).split("|").length-1,l=Number(i)+Number(t)+1;let r=0;for(let e=o;e<=a;e++)t<=s-1?n[r].nelist=y:(l>f[r]?(y=y.concat(c.slice(i,f[r])),i=Number(f[r])):y=y.concat(c.slice(i,l)),s+=y.length,n[r].nelist=y,y=[],r++)}return n}searchByDownbeat(e,t,n,s,r){const o=this._options.part,a=this._options.mstart,i=this._options.mend;let l,c,u=new Array,f=new Array,d=new Array,p=new Array,h=0,y=n[0].pms.split("-")[3],v=[];for(let e=a;e<=i;e++){const n=this._xmldata.part[o].measure[e],a=n.melody,i=n.note;let l=new Array,c=n.backup[0].duration,p=s[o][e].times[0].split("/")[0],v=0;if(l.push(0),"week"==r&&Number(p)>=4){let e=new Array,t=c/p;for(let n=0;n<p;n++)e.push(t*n);switch(p){case"4":l.push(e[2]);break;case"6":l.push(e[3]);break;case"9":l.push(e[3]),l.push(e[6]);break;case"10":l.push(e[5]);break;case"12":l.push(e[6]);break;case"14":l.push(e[7])}}let m=a[y].nnum.split("|").length,b=a[y].nnum.split("|");for(let e in b){if(e==m-1)break;let n=b[e],s=i[n].duration;l.includes(v)&&(f.push(t[h][e]),void 0!==i[n].rest?e!=m-2&&u.push(Number(n)+1):u.push(n)),v+=Number(s)}d.push(f.length),h++}for(let e=0;e<f.length-1;e++)p.push(parseInt(f[e+1])-parseInt(f[e]));let m=p.join("|"),b=m.indexOf(e);if(b>-1){let t=e.split("|").length,s=0;l=0==m.substr(0,b).split("|").length?0:m.substr(0,b).split("|").length-1,c=Number(l)+Number(t)+1;let r=0;for(let e=a;e<=i;e++)t<=s-1?n[r].nelist=v:(c>d[r]?(v=v.concat(u.slice(l,d[r])),l=Number(d[r])):v=v.concat(u.slice(l,c)),s+=v.length,n[r].nelist=v,v=[],r++)}return n}measureDraw(e,t,n){const s=new Array(t.length);let r=10;for(let o=0;o<t.length;o++){s[o]={};const[a,i,l,c]=t[o].pms.split("-"),u=t[o].nelist,f=this._VF,d=this._xmldata.part[a].measure[i];s[o].clef=e[a][i].clef,s[o].kscnt=e[a][i].kscnt,s[o].tmcnt=e[a][i].tmcnt,s[o].times=e[a][i].times,s[o].keys=e[a][i].keys,s[o].clef_pos=e[a][i].clef_pos,s[o].clef_note=e[a][i].clef_note,s[o].clef_staff=e[a][i].clef_staff,s[o].size=this._width[i]+(0==o?200:0),s[o].staves=new Array(e[a].stavecnt);let p=0,h={continue:!1,number:0};for(let t=0;t<e[a].stavecnt;t++){if(s[o].staves[t]=new f.Stave(r,30+170*Number(t),s[o].size),-1==d.number.indexOf("X")&&(p=d.number),0==o?(s[o].staves[t].addClef(s[o].clef[t]),s[o].staves[t].addKeySignature(s[o].keys[t]),s[o].staves[0].setMeasure(p),s[o].staves[t].addTimeSignature(s[o].times[t])):s[o].kscnt[t]=0,0<s[o].clef_pos.length)for(let e in s[o].clef_pos){const n=s[o].clef_staff[e];if(n==t&&1e4==s[o].clef_pos[e]){s[o].staves[n].addEndClef(s[o].clef_note[e],"small");break}}if(void 0!==d.barline)for(let n in d.barline){if(void 0!==d.barline[n].ending)switch(d.barline[n].ending.type){case"start":let e=!0;for(let t=Number(n)+1;t<d.barline.length;t++)if(void 0!==d.barline[t].ending&&"stop"==d.barline[t].ending.type){d.barline[t].ending.type="custom_start_stop",e=!1;break}e&&(s[o].staves[t].setVoltaType(f.Volta.type.BEGIN,d.barline[n].ending.number+".",10),h.continue=!0,h.number=d.barline[n].ending.number);break;case"discontinue":s[o].staves[t].setVoltaType(f.Volta.type.MID,d.barline[n].ending.number+".",10),h.continue=!1,h.number=0;break;case"stop":s[o].staves[t].setVoltaType(f.Volta.type.END,d.barline[n].ending.number+".",10),h.continue=!1,h.number=0;break;case"custom_start_stop":s[o].staves[t].setVoltaType(f.Volta.type.BEGIN_END,d.barline[n].ending.number+".",10),h.continue=!1,h.number=0;break;default:h.continue=!1,h.number=0}else h.continue&&0==t&&s[o].staves[t].setVoltaType(f.Volta.type.MID,h.number+".",10);if(void 0!==d.barline[n].repeat)switch(d.barline[n].repeat.direction){case"forward":s[o].staves[t].setBegBarType(f.Barline.type.REPEAT_BEGIN),s[o].staves[t].modifiers[0].padding=3;break;case"backward":s[o].staves[t].setEndBarType(f.Barline.type.REPEAT_END)}else if(1==e[a].stavecnt&&void 0!==d.barline[t].location)switch(d.barline[t].location){case"left":if(void 0!==d.barline[t].style)switch(d.barline[t].style){case"light-light":case"heavy-light":s[o].staves[t].setBegBarType(f.Barline.type.DOUBLE);break;case"none":s[o].staves[t].setBegBarType(f.Barline.type.NONE)}break;case"right":if(void 0!==d.barline[t].style)switch(d.barline[t].style){case"light-light":s[o].staves[t].setEndBarType(f.Barline.type.DOUBLE);break;case"light-heavy":s[o].staves[t].setEndBarType(f.Barline.type.END);break;case"none":s[o].staves[t].setEndBarType(f.Barline.type.NONE)}}}else h.continue&&s[o].staves[t].setVoltaType(f.Volta.type.MID,h.number+".",10)}if(void 0!==d.direction){let e=d.order.split(","),t=0,n=0,r=1e3;for(let a in e)if("ws"==e[a]){let e=f.Modifier.Position.ABOVE;"below"==d.direction[n].placement&&(e=f.Modifier.Position.BELOW);let t=0;void 0!==d.direction[n].staff&&(t=Number(d.direction[n].staff)-1);let a=f.TextNote.Justification.LEFT;switch(d.direction[n].words){case"D.C.":case"D.C. al":case"D.C. al Fine":case"D.S.":case"D.S. al Coda":case"D.S. al Fine":case"Fine":a=f.TextNote.Justification.RIGHT;break;case"cresc.":case"dim.":a=f.TextNote.Justification.CENTER}let i=0,l=-6;void 0!==d.direction[n].default&&void 0!==d.direction[n].default.y&&0>Number(d.direction[n].default.y)&&(e=f.Modifier.Position.BELOW,l=25),void 0!==d.direction[n].relative&&d.direction[n].relative.x,f.TextNote.Justification.LEFT==a&&(i=6,f.Modifier.Position.ABOVE==e&&(1e3==r?(l=-6,r=-6):-6==r?(l=-26,r=-26):-26==r&&(l=-46)));try{s[o].staves[t].setText(d.direction[n].words,e,{justification:a,shift_x:i,shift_y:l})}catch(e){}n++}else if("rl"==e[a])n++;else if("bt"==e[a])n++;else if("pl"==e[a])n++;else if("dy"==e[a])n++;else if("we"==e[a])n++;else if("od"==e[a])n++;else if("os"==e[a]){let e=d.direction[n].octaveshift;"up"==e.type||"down"==e.type?"down"==e.type?(s[o].osdownnum=e.number,s[o].osdownstart=t,s[o].osdownval=-1,s[o].osdownstaff=d.direction[n].staff-1):"up"==e.type&&(s[o].osupnum=e.number,s[o].osupstart=t,s[o].osupval=1,s[o].osupstaff=d.direction[n].staff-1):"stop"==e.type?(void 0!==s[o].osdownstart&&s[o].osdownnum==e.number&&(s[o].osdownstop=t),void 0!==s[o].osupstart&&s[o].osupnum==e.number&&(s[o].osupstop=t)):e.type,n++}else"me"==e[a]?n++:"ne"==e[a]&&t++}for(let t=0;t<e[a].stavecnt;t++)s[o].staves[t].setContext(n).draw();let y=null,v=null;if(2==e[a].stavecnt){if(2==e[a].stavecnt&&new f.StaveConnector(s[o].staves[0],s[o].staves[1]).setType(f.StaveConnector.type.SINGLE_LEFT).setContext(n).draw(),void 0!==d.barline)for(let e in d.barline)switch(d.barline[e].location){case"left":if(void 0!==d.barline[e].style)switch(y=new f.StaveConnector(s[o].staves[0],s[o].staves[1]).setType(f.StaveConnector.type.SINGLE_LEFT),d.barline[e].style){case"light-light":y.setType(f.StaveConnector.type.THIN_DOUBLE);break;case"heavy-light":y.setType(f.StaveConnector.type.BOLD_DOUBLE_LEFT),hasbarline?y.setXShift(s[o][bstart][i].staves[0].start_x-s[o][bstart][i].staves[0].x-5.5):y.setXShift(s[o].staves[0].start_x-s[o].staves[0].x-5.5);break;case"none":y.setType(f.StaveConnector.type.NONE)}break;case"right":if(void 0!==d.barline[e].style)switch(v=new f.StaveConnector(s[o].staves[0],s[o].staves[1]).setType(f.StaveConnector.type.SINGLE_RIGHT),d.barline[e].style){case"light-light":v.setType(f.StaveConnector.type.THIN_DOUBLE);break;case"light-heavy":v.setType(f.StaveConnector.type.BOLD_DOUBLE_RIGHT);break;case"none":v.setType(f.StaveConnector.type.NONE)}}null==y&&(y=new f.StaveConnector(s[o].staves[0],s[o].staves[1]).setType(f.StaveConnector.type.SINGLE_LEFT)),null==v&&(v=new f.StaveConnector(s[o].staves[0],s[o].staves[1]).setType(f.StaveConnector.type.SINGLE_RIGHT)),y.setContext(n).draw(),v.setContext(n).draw()}const m=new Array,b=new Array,w=new Array,g=new Array,_=new Array,A=new Array,k=new Array,C=new Array,E=new Array(e[a].stavecnt);let T=0,N=null,x=null,S=null,B=null,D={continue:!1,number:0};for(let t=0;t<e[a].stavecnt;t++)E[t]={has:!1,val:0,staff:0,end:null};const G=Number(d.note.length);let F=0;for(let e=0;e<G;e++)C[Number(d.note[e].voice)]=!0,void 0!==d.note[e].lyric&&d.note[e].lyric.length>F&&(F=d.note[e].lyric.length);const I=new Array;for(let e=1;e<C.length;e++)null!=C[e]&&I.push(e);const L=new Array(I.length),M=new Array,O=new Array,V=new Array(F),j=new Array,P=new Array,R=s[o].clef_note.slice(0),z={};for(let e in m)m[e].newsystem=!0;for(let e in b)b[e].newsystem=!0;for(let e in w)w[e].newsystem=!0;for(let e=0;e<I.length;e++){const t=I[e].toString(),n=s[o].times[0].split("/"),r=n[0]||4,a=n[1]||4;try{O[e]=new f.Voice({num_beats:r,beat_value:a,resolution:f.RESOLUTION})}catch(e){}const i=new Array,l=new Array(F),c=new Array,p=new Array,h=new Array;let y=new Array,v=new Array;for(let e=0;e<F;e++)l[e]=new Array;0==e&&(z.clef=s[o].clef.slice(0),z.pos=s[o].clef_pos.slice(0),z.note=s[o].clef_note.slice(0),z.count=Number(z.pos.length));for(let n=0;n<G;n++){const r=d.note[n];if(t==r.voice&&void 0===r.chord){void 0!==r.staff?L[e]=Number(r.staff)-1:L[e]=0;let a={},w=null,g=null;if(0<z.count)for(let t in z.pos)if(0<n&&n==z.pos[t]){if(w=z.note[t],z.clef[L[e]]=w,z.note.splice(t,1),z.pos.splice(t,1),z.count=Number(z.pos.length),0<R.length){const e=new f.ClefNote(w,"small");g=new f.NoteSubGroup([e]),R.splice(t,1)}break}a.clef=z.clef[L[e]],a.duration=Duration.parseDuration(r.type),void 0!==r.dot&&(a.duration=a.duration+"d"),void 0!==r.rest&&(a.duration=a.duration+"r",void 0!==s[o].osdownstart&&n==s[o].osdownstart&&(E[L[e]].has=!0,E[L[e]].val=s[o].osdownval,E[L[e]].staff=s[o].osdownstaff),void 0!==s[o].osupstart&&n==s[o].osupstart&&(E[L[e]].has=!0,E[L[e]].val=s[o].osupval,E[L[e]].staff=s[o].osupstaff),void 0!==s[o].osdownstop&&n==s[o].osdownstop&&(E[L[e]].has=!1,E[L[e]].val=0,E[L[e]].staff=0,E[L[e]].stop=null),void 0!==s[o].osupstop&&n==s[o].osupstop&&(E[L[e]].has=!1,E[L[e]].val=0,E[L[e]].staff=0,E[L[e]].stop=null)),void 0!==r.stem&&(a.stem_direction=1,"down"==r.stem&&(a.stem_direction=-1));let k=0;if(a.accidental=new Array,a.accidental_number=new Array,a.keys=["B/4"],"bass"==a.clef&&(a.keys=["D/3"]),void 0!==r.pitch)for(let t=n;t<G;t++){const r=d.note[t];let i=null;if(n==t){if(i=r.pitch.octave,void 0!==s[o].osdownstart&&n==s[o].osdownstart&&(E[L[e]].has=!0,E[L[e]].val=s[o].osdownval,E[L[e]].staff=s[o].osdownstaff),void 0!==s[o].osupstart&&n==s[o].osupstart&&(E[L[e]].has=!0,E[L[e]].val=s[o].osupval,E[L[e]].staff=s[o].osupstaff),E[L[e]].has&&E[L[e]].staff==L[e]&&(i=Number(i)+E[L[e]].val),a.keys=[r.pitch.step+"/"+i],void 0!==s[o].osdownstop&&n==s[o].osdownstop){E[L[e]].stop=s[o].osdownstop;for(let n=t+1;n<G&&void 0!==d.note[n].chord;n++)E[L[e]].stop=n;n==E[L[e]].stop&&(E[L[e]].has=!1,E[L[e]].val=0,E[L[e]].staff=0,E[L[e]].stop=null)}if(void 0!==s[o].osupstop&&n==s[o].osupstop){E[L[e]].stop=s[o].osupstop;for(let n=t+1;n<G&&void 0!==d.note[n].chord;n++)E[L[e]].stop=n;n==E[L[e]].stop&&(E[L[e]].has=!1,E[L[e]].val=0,E[L[e]].staff=0,E[L[e]].stop=null)}}else{if(void 0===r.chord||void 0===r.pitch)break;i=r.pitch.octave,E[L[e]].has&&E[L[e]].staff==L[e]&&(i=Number(i)+E[L[e]].val),a.keys.push(r.pitch.step+"/"+i),t==E[L[e]].stop&&(E[L[e]].has=!1,E[L[e]].val=0,E[L[e]].stop=null),k++}if(void 0!==r.accidental){a.accidental_number.push(k);const e=Accidental.parseAccidental(r.accidental);a.accidental.push(new f.Accidental(e))}}if(void 0!==r.beam)for(let e in r.beam)if("begin"==r.beam[e].type){const s=c.length;c[s]=new Array,c[s].push(n);let o=!1;for(let a=Number(n)+1;a<G&&!o;a++){const n=d.note[a];if(t==n.voice&&void 0!==n.beam)for(let t in n.beam)if(r.beam[e].number==n.beam[t].number){"continue"==n.beam[t].type?c[s].push(a):"end"==n.beam[t].type&&(c[s].push(a),o=!0);break}}}else"forward hook"==r.beam[e].type||r.beam[e].type;if(void 0!==r.tuplet)for(let e in r.tuplet)if("start"==r.tuplet[e].type&&r.tuplet[e].show_number){const s=p.length;p[s]=new Array,p[s].push(n),h[s]={num_notes:r.time.actual_notes,notes_occupied:r.time.normal_notes,location:1==a.stem_direction?-1:1,bracketed:r.tuplet[e].bracket,bracketed:!1};let o=!1;for(let a=Number(n)+1;a<G&&!o;a++){const n=d.note[a];if(t==n.voice&&void 0===n.chord&&void 0===n.grace&&n.print&&(p[s].push(a),void 0!==n.tuplet))for(let t in n.tuplet)if(r.tuplet[e].number==n.tuplet[t].number){"stop"==n.tuplet[t].type&&(o=!0);break}}}if(void 0!==r.nts){let e=null,t=null,n=0;const s=1==a.stem_direction?"below":"above";if(void 0!==r.nts.fermata)e="above"==s?"a@a":"a@u";else if(void 0!==r.nts.articulations){const t=r.nts.articulations;void 0!==t.staccato?e="a.":void 0!==t.staccatissimo?e="av":void 0!==t.accent?e="a>":void 0!==t.tenuto?e="a-":void 0!==t.marcato&&(e="a^")}else if(void 0!==r.nts.technical){const t=r.nts.technical;void 0!==t.up_bow?e="a|":void 0!==t.down_bow?e="am":void 0!==t.fingering&&(a.handfinger=new f.FretHandFinger(t.fingering.number).setPosition(s))}if(null!=e&&(a.articulation=new f.Articulation(e).setPosition(s)),void 0!==r.nts.ornaments){const e=r.nts.ornaments;void 0!==e.trill_mark?t="tr":void 0!==e.mordent?t="mordent":void 0!==e.inverted_mordent?t="mordent_inverted":void 0!==e.turn?t="turn":void 0!==e.tremolo?"start"==e.tremolo.type?(t="tremolo",n=e.tremolo.number,D.number=n,D.continue=!0):"stop"==e.tremolo.type?(t="tremolo",n=e.tremolo.number,D.number=0,D.continue=!1):"single"==e.tremolo.type&&(t="tremolo",n=e.tremolo.number):e.wavy_line}null!=t&&(a.ornament="tremolo"==t?new f.Tremolo(n):new f.Ornament(t)),void 0!==r.nts.arpeggiate&&(a.arpeggiate=new f.Stroke(f.Stroke.Type.ROLL_UP,{}),void 0!==r.nts.arpeggiate.direction&&"up"==r.nts.arpeggiate.direction&&(a.arpeggiate=new f.Stroke(f.Stroke.Type.ROLL_DOWN,{})))}else D.continue&&(a.ornament=new f.Tremolo(D.number));if(r.print)if(void 0!==r.grace){this._options.slashon&&(a.slash=r.grace.slash);let e=null;try{e=new f.GraceNote(a)}catch(e){}if(void 0!==r.dot&&e.addDotToAll(),void 0!==a.articulation&&e.addArticulation(0,a.articulation),void 0!==a.ornament&&e.addModifier(0,a.ornament),void 0!==a.handfinger&&e.addModifier(0,a.handfinger),void 0!==a.arpeggiate&&e.addModifier(0,a.arpeggiate),0<a.accidental.length&&e.addAccidental(0,a.accidental[0]),y.push(e),void 0!==r.tie){const t=r.pitch.step+"/"+r.pitch.octave;for(let n in r.tie)if("start"==r.tie[n].type)m.push({first_note:e,first_indices:[0],key:t,voice:r.voice,newsystem:!1,done:!1});else{for(let n=m.length-1;0<=n;n--)if(!m[n].done&&m[n].key==t){m[n].newsystem?(m[n].done=!0,m.push({last_note:e,last_indices:[0],done:!0})):(m[n].done=!0,m[n].last_note=e,m[n].last_indices=[0]);break}}}if(void 0!==r.slur)for(let t in r.slur)if("start"==r.slur[t].type)b.push({first_note:e,last_note:null,number:r.slur[t].number,voice:r.voice,newsystem:!1,done:!1});else{for(let n=b.length-1;0<=n;n--)if(!b[n].done&&b[n].number==r.slur[t].number){b[n].newsystem?(b[n].done=!0,b.push({first_note:null,last_note:e,done:!0})):(b[n].done=!0,b[n].last_note=e);break}}}else{try{M[n]=new f.StaveNote(a),T<u.length&&n==u[T]&&(M[n].setKeyStyle(0,{shadowBlur:15,shadowColor:"red",fillStyle:"red"}),T++)}catch(e){}if(void 0!==r.dot)for(let e=0;e<r.dot.cnt;e++)M[n].addDotToAll();if(void 0!==a.articulation&&M[n].addArticulation(0,a.articulation),void 0!==a.ornament&&M[n].addModifier(0,a.ornament),void 0!==a.handfinger&&M[n].addModifier(0,a.handfinger),void 0!==a.arpeggiate&&M[n].addModifier(0,a.arpeggiate),i.push(M[n]),null!=g&&M[n].addModifier(0,g),0<y.length){try{M[n].addModifier(0,new f.GraceNoteGroup(y,!1).beamNotes())}catch(e){}y=new Array}for(let e in a.accidental)M[n].addAccidental(a.accidental_number[e],a.accidental[e]);k=0;for(let e=n;e<G;e++){const t=d.note[e];if(n<e){if(void 0===t.chord||void 0===t.pitch)break;k++}if(void 0!==t.tie){const e=t.pitch.step+"/"+t.pitch.octave;for(let s in t.tie)if("start"==t.tie[s].type)m.push({first_note:M[n],first_indices:[k],key:e,voice:t.voice,newsystem:!1,done:!1});else{for(let t=m.length-1;0<=t;t--)if(!m[t].done&&m[t].key==e){m[t].newsystem?(m[t].done=!0,m.push({last_note:M[n],last_indices:[k],done:!0})):(m[t].done=!0,m[t].last_note=M[n],m[t].last_indices=[k]);break}}}if(void 0!==t.slur)for(let e in t.slur)if("start"==t.slur[e].type)b.push({first_note:M[n],last_note:null,number:t.slur[e].number,voice:t.voice,newsystem:!1,done:!1});else{for(let s=b.length-1;0<=s;s--)if(!b[s].done&&b[s].number==t.slur[e].number){b[s].newsystem?(b[s].done=!0,b.push({first_note:null,last_note:M[n],done:!0})):(b[s].done=!0,b[s].last_note=M[n]);break}}if(void 0!==t.nts){if(void 0!==t.nts.glissando){const e=t.nts.glissando;if("start"==e.type)_.push({first_note:M[n],first_indices:[k],number:e.number,line_type:e.line_type,text:e.text,done:!1});else{for(let t=_.length-1;0<=t;t--)_[t].done||_[t].number!=e.number||(_[t].done=!0,_[t].last_note=M[n],_[t].last_indices=[k])}}if(void 0!==t.nts.ornaments&&void 0!==t.nts.ornaments.wavy_line){const e=t.nts.ornaments.wavy_line;if("start"==e.type)A.push({start:M[n],number:e.number,done:!1});else{for(let t=A.length-1;0<=t;t--)A[t].done||A[t].number!=e.number||(A[t].done=!0,A[t].stop=M[n])}}}}}else{try{M[n]=new f.GhostNote(a)}catch(e){}i.push(M[n])}const C=12;let N=new Array(F),x=new Array(F);for(let e=0;e<F;e++){if(x[e]={text:"",line:C,clef:a.clef,keys:a.keys,duration:a.duration,smooth:!0,justification:f.TextNote.Justification.LEFT,font:{family:"Alegreya",size:12,weight:""}},void 0!==r.lyric)for(let t=0;t<r.lyric.length;t++){if(e==Number(r.lyric[t].number)-1&&(x[e].text=r.lyric[t].text,x[e].line=C+2*e,void 0!==r.lyric[t].syllabic&&("begin"!=r.lyric[t].syllabic&&"middle"!=r.lyric[t].syllabic||(x[e].text+="-")),void 0!==r.lyric[t].justify))switch(r.lyric[t].justify){case"center":x[e].justification=f.TextNote.Justification.CENTER;break;case"right":x[e].justification=f.TextNote.Justification.RIGHT}}void 0===r.grace?(0<v.length&&(x[e].text=v[e].text,x[e].justification=v[e].justification,v=new Array),N[e]=new f.TextNote(x[e]),N[e].setStave(s[o].staves[0]),l[e].push(N[e])):v.push(x[e])}}}let w=0;const g=new Array(c.length);for(let e in c){for(let t in c[e])null==g[w]&&(g[w]=new Array),g[w].push(M[c[e][t]]);j.push(new f.Beam(g[w])),w++}let k=0;const C=new Array(p.length);for(let e in p){for(let t in p[e])null==C[k]&&(C[k]=new Array),C[k].push(M[p[e][t]]);P.push(new f.Tuplet(C[k],h[k])),k++}try{O[e].setMode(f.Voice.Mode.SOFT),O[e].addTickables(i);for(let e=0;e<F;e++)V[e]=new f.Voice({num_beats:r,beat_value:a,resolution:f.RESOLUTION}),V[e].setMode(f.Voice.Mode.SOFT),V[e].addTickables(l[e])}catch(e){}}if(void 0!==d.direction){let e=d.order.split(","),t=0,n=0;for(let s in e)if("we"==e[s]){const e=d.direction[n].wedge;if("crescendo"==e.type||"diminuendo"==e.type){const n="crescendo"==e.type?1:2;let s=M[t];if(void 0===s)for(let e=t+1;e<M.length;e++)if(void 0!==M[e]){s=M[e];break}w.push({type:n,number:e.number,first_note:s,last_note:null,newsystem:!1,done:!1})}else if("stop"==e.type)for(let n=w.length-1;0<=n;n--)if(!w[n].done&&w[n].number==e.number){if(w[n].newsystem)w.splice(n,1);else{if(0==t){for(let e=N.length-1;0<=e;e--)if(void 0!==N[e]){w[n].last_note=N[e],w[n].done=!0;break}}else for(let e=t-1;0<=e;e--)if(void 0!==M[e]){w[n].last_note=M[e],w[n].done=!0;break}w[n].done||w.splice(n,1)}break}n++}else if("pl"==e[s]){let e=d.direction[n].pedal;if("start"==e.type)x=new Array,x.push(M[t]);else if("stop"==e.type){let n="yes"==e.line;null!=x&&(x.push(M[t]),g.push({notes:x,line:n})),x=null}n++}else if("dy"==e[s]){const e=new f.Annotation(d.direction[n].dynamics);e.setFont("Alegreya",14,"bold italic"),e.setJustification(f.Annotation.Justify.CENTER),e.setVerticalJustification(f.Annotation.VerticalJustify.BOTTOM);for(let n=t;n<Number(d.note.length);n++)if(void 0!==M[n]&&"GhostNote"!=M[n].attrs.type){M[n].addAnnotation(0,e);break}n++}else if("ws"==e[s])n++;else if("rl"==e[s])n++;else if("me"==e[s])n++;else if("bt"==e[s])n++;else if("od"==e[s])n++;else if("os"==e[s]){let e=d.direction[n].octaveshift,s={start:M[t],stop:null,number:e.number,text:e.size,font:{family:"Serif",size:15,weight:"italic"}};if("up"==e.type||"down"==e.type)"down"==e.type?(B=s,B.superscript="va",B.position=f.TextBracket.Positions.TOP):"up"==e.type&&(S=s,S.superscript="vb",S.position=f.TextBracket.Positions.BOTTOM);else if("stop"==e.type){if(null==B&&null==S)continue;null!=B&&B.number==e.number&&(B.stop=M[t],k.push(new f.TextBracket(B).setLine(3)),B=null),null!=S&&S.number==e.number&&(S.stop=M[t],k.push(new f.TextBracket(S).setLine(3)),S=null)}else e.type;n++}else"ne"==e[s]&&t++}try{let e=new f.Formatter;for(let t=0;t<O.length;t++)e.joinVoices([O[t]]);for(let t=0;t<V.length;t++)e.joinVoices([V[t]]);let t=15+12*s[o].kscnt[0]+20*s[o].tmcnt;0==o?(t+=30,1e4==s[o].clef_pos[s[o].clef_pos.length-1]&&(t+=20)):0<s[o].clef_pos.length&&(t+=20,1e4==s[o].clef_pos[s[o].clef_pos.length-1]&&(t+=10)),e.format(O,s[o].size-t);for(let n=0;n<V.length;n++)e.format([O[0],V[n]],s[o].size-t)}catch(e){}for(let e in O)try{O[e].draw(n,s[o].staves[L[e]])}catch(e){}for(let e in V)try{V[e].setContext(n).draw()}catch(e){}j.forEach((function(e){try{e.setContext(n).draw()}catch(e){}})),P.forEach((function(e){try{e.setContext(n).draw()}catch(e){}})),m.forEach((function(e){try{new f.StaveTie(e).setContext(n).draw()}catch(e){}})),this._options.sluron&&b.forEach((function(e){try{new f.Curve(e.first_note,e.last_note,{cps:[{x:0,y:20},{x:0,y:20}]}).setContext(n).draw()}catch(e){}})),w.forEach((function(e){try{new f.StaveHairpin({first_note:e.first_note,last_note:e.last_note},e.type).setContext(n).draw()}catch(e){}})),A.forEach((function(e){try{new f.VibratoBracket(e).setContext(n).draw()}catch(e){}})),_.forEach((function(e){try{let t=new f.StaveLine(e);void 0!==e.text&&(t.setText(e.text),t.setFont({family:"Alegreya",size:8,weight:"lighter italic"})),t.setContext(n),t.applyFontStyle(),t.draw()}catch(e){}})),k.forEach((function(e){try{e.setContext(n).draw()}catch(e){}})),r+=Number(s[o].size)}}convMidiNum(e,t,n){if("number"!=typeof t)throw new Error("octave must number.");if("string"!=typeof e)throw new Error("step must string.");if("C"!=(e=e.toUpperCase())&&"D"!=e&&"E"!=e&&"F"!=e&&"G"!=e&&"A"!=e&&"B"!=e)throw new Error("Invalid step.");if(void 0!==n&&0!=n&&(e=this.convStep(e,n)),t<-1||t>9)throw new Error("Octave out of range.");if(9==t&&("G#"==e||"A"==e||"A#"==e||"B"==e))throw new Error("Octave out of range.");return{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[e]+12*(t+1)}convStep(e,t){if(t<-2||t>2)throw new Error(RangeError);if(1==t)return"E"==e?"F":"B"==e?"C":e+"#";if(-1==t)return{C:"B",D:"C#",E:"D#",F:"E",G:"F#",A:"G#",B:"A#"}[e];if(-2==t)return{C:"A#",D:"C",E:"D",F:"D#",G:"F",A:"G",B:"A"}[e];if(2==t)return{C:"D",D:"E",E:"F#",F:"G",G:"A",A:"B",B:"C#"}[e];throw new Error(RangeError)}}class Upload{constructor(e){this.jstruct=e,this.Measure=new Measure("","",this.jstruct,{}),this.headClef=this.Measure.setHeadClef(),this.partlength=this.jstruct.part.length,this.noteInfo=new Array}parsingXml(){const e={},t=this.setPartAttr(this.jstruct.partlist,this.partlength),n=new Array(this.partlength),s=new Array(this.partlength),r=new Array(this.partlength);new Array(this.partlength);let o=new Array(this.partlength),a=0;e.part_length=this.partlength,e.measure_length=this.jstruct.part[0].measure.length,e.part=t;for(let e in this.jstruct.part){const t=this.jstruct.part[e].measure;let i=0;n[e]={},n[e].pitch=new Array,n[e].beat=new Array,n[e].weekdown=new Array,n[e].strongdown=new Array,s[e]={},s[e].pitch=new Array,s[e].beat=new Array,s[e].weekdown=new Array,s[e].strongdown=new Array,o[e]={},o[e].beat=[],o[e].weekdown=[],o[e].strongdown=[],r[e]=new Array;for(let s in t){const r=t[s],l=new Array;if(void 0!==r.melody){const t=r.melody,o=r.note;let c=!0;try{for(let r in t){if(!c)break;if(null!=t[r]){let u=t[r].pitchs.split("|");i=r;for(let t in u){let r=u[t];if(""!=r){c=!1;const[u,f,d]=r.split(":"),p=this.convMidiNum(u,Number(f),d);n[e].pitch.push(p),l.push({conv:p,nIdx:a}),this.noteInfo.push({nIdx:a,pIdx:e,mIdx:s,mNum:Number(s)+1,midi:p,step:u,octave:f,alter:d,duration:o[t].duration,voice:i,searchA:!0,searchB:!1,searchC:!1,searchD:!1}),a++}}}}}catch(e){}c=!0}o[e].beat=o[e].beat.concat(this.searchByBeat(r,l,[e,s,i])),o[e].weekdown=o[e].weekdown.concat(this.searchByDownbeat(r,l,[e,s,i],"week")),o[e].strongdown=o[e].strongdown.concat(this.searchByDownbeat(r,l,[e,s,i],"strong"))}for(let t=0;t<n[e].pitch.length-1;t++)s[e].pitch.push(parseInt(n[e].pitch[t+1])-parseInt(n[e].pitch[t]));let l={voice:i,first:n[e].pitch[0],midi:n[e].pitch.join("|"),interval:s[e].pitch.join("|"),search:1};r[e].push(l);for(let t=0;t<o[e].beat.length-1;t++)s[e].beat.push(parseInt(o[e].beat[t+1])-parseInt(o[e].beat[t]));let c={voice:i,first:o[e].beat[0],midi:o[e].beat.join("|"),interval:s[e].beat.join("|"),search:2};r[e].push(c);for(let t=0;t<o[e].weekdown.length-1;t++)s[e].weekdown.push(parseInt(o[e].weekdown[t+1])-parseInt(o[e].weekdown[t]));let u={voice:i,first:o[e].weekdown[0],midi:o[e].weekdown.join("|"),interval:s[e].weekdown.join("|"),search:3};r[e].push(u);for(let t=0;t<o[e].strongdown.length-1;t++)s[e].strongdown.push(parseInt(o[e].strongdown[t+1])-parseInt(o[e].strongdown[t]));let f={voice:i,first:o[e].strongdown[0],midi:o[e].strongdown.join("|"),interval:s[e].strongdown.join("|"),search:4};r[e].push(f)}return e.midiString=r,e.note=this.noteInfo,e}searchByPitch(e){let t=new Array;for(let n=0;n<e.length-1;n++)t.push(parseInt(e[n+1])-parseInt(e[n]));return t.join("|")}searchByBeat(e,t,[n,s,r]){const o=e.melody,a=e.note;let i=new Array,l=new Array,c=new Array,u=e.backup[0].duration,f=this.headClef[n][s].times[0].split("/")[1],d=-1,p=0,h=!1,y=o[r].nnum.split("|").length,v=o[r].nnum.split("|");for(let e in v){if(e==y-1)break;let t=v[e],n=Time.parseNumType(a[t].type),s=a[t].duration;if(h=!(!h&&void 0===a[t].tuplet),h){if(p+=Number(a[t].duration),void 0===a[t].tuplet||"stop"!=a[t].tuplet[0].type)continue;h=!1,s=p/a[t].time.normal_notes}if(n%f==0){d=s*(n/f);break}}if(-1==d&&1024==u&&(d=u/f),d>-1){let e=0,n=0;if(u%d==0)for(;e!=u;)c.push(e),e+=Number(d);else c.push(e);for(let e in v){if(e==y-1)break;let s=v[e],r=a[s].duration;if(c.includes(n)){let n=this.noteInfo[t[e].nIdx];l.push(t[e].conv),n.searchB=!0,this.noteInfo[t[e].nIdx]=n,void 0!==a[s].rest?e!=y-2&&i.push(Number(s)+1):i.push(s)}n+=Number(r)}}return l}searchByDownbeat(e,t,[n,s,r],o){const a=e.melody,i=e.note;let l=new Array,c=new Array,u=new Array,f=e.backup[0].duration,d=this.headClef[n][s].times[0].split("/")[0],p=0;if(u.push(0),"week"==o&&Number(d)>=4){let e=new Array,t=f/d;for(let n=0;n<d;n++)e.push(t*n);switch(d){case"4":u.push(e[2]);break;case"6":u.push(e[3]);break;case"9":u.push(e[3]),u.push(e[6]);break;case"10":u.push(e[5]);break;case"12":u.push(e[6]);break;case"14":u.push(e[7])}}let h=a[r].nnum.split("|").length,y=a[r].nnum.split("|");for(let e in y){if(e==h-1)break;let n=y[e],s=i[n].duration;if(u.includes(p)){let s=this.noteInfo[t[e].nIdx];c.push(t[e].conv),"week"==o?s.searchC=!0:s.searchD=!0,this.noteInfo[t[e].nIdx]=s,void 0!==i[n].rest?e!=h-2&&l.push(Number(n)+1):l.push(n)}p+=Number(s)}return c}setPartAttr(e,t){const n=new Array(t);let s=0;for(let t in e)void 0!==e[t].scorepart&&(n[s]={id:null,index:null,name:null,abbreviation:null},void 0!==e[t].scorepart.id&&(n[s].id=e[t].scorepart.id,n[s].index=s),void 0!==e[t].scorepart.name&&(n[s].name=e[t].scorepart.name),void 0!==e[t].scorepart.abbreviation&&(n[s].abbreviation=e[t].scorepart.abbreviation),s++);return n}convMidiNum(e,t,n){if("number"!=typeof t)throw new Error("octave must number.");if("string"!=typeof e)throw new Error("step must string.");if("C"!=(e=e.toUpperCase())&&"D"!=e&&"E"!=e&&"F"!=e&&"G"!=e&&"A"!=e&&"B"!=e)throw new Error("Invalid step.");if(void 0!==n&&0!=n&&(e=this.convStep(e,n)),t<-1||t>9)throw new Error("Octave out of range.");if(9==t&&("G#"==e||"A"==e||"A#"==e||"B"==e))throw new Error("Octave out of range.");return{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[e]+12*(t+1)}convStep(e,t){if(t<-2||t>2)throw new Error(RangeError);if(1==t)return"E"==e?"F":"B"==e?"C":e+"#";if(-1==t)return{C:"B",D:"C#",E:"D#",F:"E",G:"F#",A:"G#",B:"A#"}[e];if(-2==t)return{C:"A#",D:"C",E:"D",F:"D#",G:"F",A:"G",B:"A"}[e];if(2==t)return{C:"D",D:"E",E:"F#",F:"G",G:"A",A:"B",B:"C#"}[e];throw new Error(RangeError)}}